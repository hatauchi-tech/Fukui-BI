"""pytest 共通フィクスチャ"""
import os
import sys
import tempfile
from pathlib import Path

import pandas as pd
import pytest

# srcディレクトリをパスに追加
sys.path.insert(0, str(Path(__file__).parent.parent / 'src'))


@pytest.fixture
def sample_csv_content():
    """サンプルCSVデータのコンテンツ"""
    return """事業所ｺｰﾄﾞ,事業所名,事業所略名,部課ｺｰﾄﾞ,部課名,部課略名,出力帳票,改頁№,SEQNO,科目ｺｰﾄﾞ,補助ｺｰﾄﾞ,科目名,補助科目名,科目略名,貸借区分,属性区分,罫線区分,前残高,借方,貸方,残高,開始年月,終了年月
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,1,4199,0,【収入計】,,収入計,1,1,0,0,0,10000000,10000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,2,5399,0,【売上原価】,,売上原価,1,1,0,0,7000000,0,7000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,3,5400,0,【売上総利益】,,売上総利益,1,1,0,0,0,3000000,3000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,4,6299,0,(販売費及び一般管理費),,販管費,1,1,0,0,500000,0,500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,5,7000,0,【営業利益】,,営業利益,1,1,0,0,0,2500000,2500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,6,8000,0,【経常利益】,,経常利益,1,1,0,0,0,2400000,2400000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,7,9000,0,【当期利益】,,当期利益,1,1,0,0,0,2000000,2000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,1,2,1,5419,0,(製)材料費計,,材料費計,1,1,0,0,3000000,0,3000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,1,2,2,5439,0,(製)労務費計,,労務費計,1,1,0,0,2000000,0,2000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,1,2,3,5469,0,(製)経費計,,経費計,1,1,0,0,1500000,0,1500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,8,5299,0,【当期製品製造原価】,,製造原価,1,1,0,0,6500000,0,6500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,1,4199,0,【収入計】,,収入計,1,1,0,0,0,8000000,8000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,2,5399,0,【売上原価】,,売上原価,1,1,0,0,6000000,0,6000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,3,5400,0,【売上総利益】,,売上総利益,1,1,0,0,0,2000000,2000000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,4,6299,0,(販売費及び一般管理費),,販管費,1,1,0,0,300000,0,300000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,5,7000,0,【営業利益】,,営業利益,1,1,0,0,0,1700000,1700000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,6,8000,0,【経常利益】,,経常利益,1,1,0,0,0,1600000,1600000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,7,9000,0,【当期利益】,,当期利益,1,1,0,0,0,1300000,1300000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,0,1,8,5299,0,【当期製品製造原価】,,製造原価,1,1,0,0,5500000,0,5500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,1,2,1,5419,0,(製)材料費計,,材料費計,1,1,0,0,2500000,0,2500000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,1,2,2,5439,0,(製)労務費計,,労務費計,1,1,0,0,1800000,0,1800000,2025/07,2025/07
1,福井鐵工株式会社,福井鐵工,220,社会インフラ製作,社会製作,1,2,3,5469,0,(製)経費計,,経費計,1,1,0,0,1200000,0,1200000,2025/07,2025/07
"""


@pytest.fixture
def sample_csv_august():
    """8月のサンプルCSVデータ"""
    return """事業所ｺｰﾄﾞ,事業所名,事業所略名,部課ｺｰﾄﾞ,部課名,部課略名,出力帳票,改頁№,SEQNO,科目ｺｰﾄﾞ,補助ｺｰﾄﾞ,科目名,補助科目名,科目略名,貸借区分,属性区分,罫線区分,前残高,借方,貸方,残高,開始年月,終了年月
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,1,4199,0,【収入計】,,収入計,1,1,0,10000000,0,12000000,22000000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,2,5399,0,【売上原価】,,売上原価,1,1,0,7000000,8000000,0,15000000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,3,5400,0,【売上総利益】,,売上総利益,1,1,0,3000000,0,4000000,7000000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,4,6299,0,(販売費及び一般管理費),,販管費,1,1,0,500000,600000,0,1100000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,5,7000,0,【営業利益】,,営業利益,1,1,0,2500000,0,3400000,5900000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,6,8000,0,【経常利益】,,経常利益,1,1,0,2400000,0,3300000,5700000,2025/08,2025/08
1,福井鐵工株式会社,福井鐵工,210,建機事業部,建機,0,1,7,9000,0,【当期利益】,,当期利益,1,1,0,2000000,0,2800000,4800000,2025/08,2025/08
"""


@pytest.fixture
def temp_data_folder(sample_csv_content, sample_csv_august, tmp_path):
    """テスト用の一時データフォルダを作成"""
    data_folder = tmp_path / "損益計算書"
    data_folder.mkdir()

    # 7月のCSV
    csv_file_july = data_folder / "2025_07_損益計算書.csv"
    csv_file_july.write_text(sample_csv_content, encoding='utf-8')

    # 8月のCSV
    csv_file_august = data_folder / "2025_08_損益計算書.csv"
    csv_file_august.write_text(sample_csv_august, encoding='utf-8')

    return data_folder


@pytest.fixture
def empty_data_folder(tmp_path):
    """空のデータフォルダ"""
    data_folder = tmp_path / "損益計算書"
    data_folder.mkdir()
    return data_folder


@pytest.fixture
def sample_dataframe(sample_csv_content):
    """サンプルDataFrame"""
    import io
    df = pd.read_csv(io.StringIO(sample_csv_content))
    df['source_file'] = '2025_07_損益計算書.csv'
    df['year_month'] = '2025/07'
    return df


def _create_test_loader(data_folder_path):
    """テスト用のDataLoaderを作成するヘルパー関数（内部用）"""
    from data_loader import DataLoader

    # DataLoaderを継承して、data_folderを直接指定できるようにする
    class TestDataLoader(DataLoader):
        def __init__(self, data_folder_path):
            # 親の__init__を呼ばずに直接設定
            self.base_path = data_folder_path.parent
            self.data_folder = data_folder_path
            self._df = None
            self._loaded_files = []

    return TestDataLoader(data_folder_path)


@pytest.fixture
def test_loader(temp_data_folder):
    """テスト用DataLoaderフィクスチャ（テストデータフォルダを使用）"""
    return _create_test_loader(temp_data_folder)


@pytest.fixture
def empty_test_loader(empty_data_folder):
    """空データ用テストローダーフィクスチャ"""
    return _create_test_loader(empty_data_folder)
